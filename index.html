<script>
let saldo = 5000.00;
const history = document.getElementById('history');
const saldoEl = document.getElementById('saldo');

function format(v){return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}
function renderSaldo(){saldoEl.innerText = format(saldo)}

function toast(msg){
  const t=document.getElementById('toast');
  t.innerText=msg; t.style.display='block';
  setTimeout(()=>t.style.display='none',2500);
}

function openPix(){pixModal.style.display='flex'}
function openReceive(){receiveModal.style.display='flex'; gerarPix()}
function openScan(){
  const i=document.createElement("input");
  i.type="file"; i.accept="image/*";
  i.onchange=()=>{toast("QR lido (simulado)"); setTimeout(()=>toast("Pagamento concluído"),1200);}
  i.click();
}
function openCard(){cardModal.style.display='flex'}
function closeAll(){[pixModal,bioModal,receiveModal,receiptModal,cardModal].forEach(m=>m.style.display='none')}

function setAvatar(e){
  const f=e.target.files[0];
  if(!f) return;
  const r=new FileReader();
  r.onload=()=>{avatarImg.src=r.result;avatarImg.style.display="block";avatarIcon.style.display="none";}
  r.readAsDataURL(f);
}

function biometria(){
  if(!pixValor.value||parseFloat(pixValor.value)<=0) return alert("Valor inválido");
  pixModal.style.display='none'; bioModal.style.display='flex';
}

function gerarCodigo(){return Math.random().toString(36).substr(2,10).toUpperCase()}
function randomCode(n){return Math.random().toString(36).substr(2,n).toUpperCase()}

function confirmarPix(){
  bioModal.style.display='none';
  const v=parseFloat(pixValor.value);
  saldo-=v; renderSaldo();
  const item=document.createElement("div");
  item.className="item";
  item.innerHTML=`<div>${pixNome.value}</div><div>- ${format(v)}</div>`;
  history.prepend(item);

  const d=new Date();
  receiptBody.innerHTML=`
  <p><b>Para:</b> ${pixNome.value}</p>
  <p><b>Chave:</b> ${pixChave.value}</p>
  <p><b>Valor:</b> ${format(v)}</p>
  <p><b>Data:</b> ${d.toLocaleDateString("pt-BR")}</p>
  <p><b>Hora:</b> ${d.toLocaleTimeString("pt-BR")}</p>
  <p><b>ID Autenticação:</b> AUT-${gerarCodigo()}</p>
  <p><b>Protocolo:</b> PRT-${Math.floor(Math.random()*1e9)}</p>
  <p><b>Status:</b> Concluído</p>`;
  receiptModal.style.display='flex';
}

function gerarPix(){
  const c="PIX-"+randomCode(20);
  QRCode.toCanvas(qr,c,{width:180});
  receiveInfo.innerHTML="Chave Pix: "+c;
}
function gerarBoleto(){
  const b=Math.floor(1e46+Math.random()*9e46).toString().slice(0,47);
  QRCode.toCanvas(qr,b,{width:180});
  receiveInfo.innerHTML="Código de barras:<br>"+b;
}
function gerarLink(){
  const l="https://pagar.me/"+randomCode(12);
  QRCode.toCanvas(qr,l,{width:180});
  receiveInfo.innerHTML="Link: "+l;
}

function downloadPDF(){
  html2pdf().from(document.getElementById("receipt")).save("comprovante_simulado.pdf");
}

renderSaldo();
</script>
</body>
</html>
